<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üê¨ Flipper BLE Stealth</title>
    <style>
        :root { --bg: #000; --text: #00e5ff; --panel: #111; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Courier New', monospace; display: flex; flex-direction: column; height: 100vh; margin: 0; overflow: hidden; }
        
        /* Top Bar */
        header { background: var(--panel); padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        h1 { margin: 0; font-size: 16px; letter-spacing: 1px; color: #fff; }
        #status { font-size: 10px; color: #666; margin-top: 5px; }
        
        /* Connect Button */
        #btn-bt { background: #004d40; color: #4db6ac; border: 1px solid #00695c; padding: 8px 12px; border-radius: 4px; font-weight: bold; font-size: 12px; cursor: pointer; }
        
        /* Terminal */
        #term { flex-grow: 1; overflow-y: auto; padding: 15px; font-size: 14px; white-space: pre-wrap; line-height: 1.3; -webkit-overflow-scrolling: touch; }
        
        /* Input */
        .input-zone { display: flex; border-top: 1px solid #333; background: var(--panel); padding: 8px; }
        input { flex-grow: 1; background: #000; border: 1px solid #444; color: #fff; padding: 10px; font-family: inherit; font-size: 16px; border-radius: 4px; outline: none; }
        button#send { background: #333; color: #fff; border: 1px solid #444; padding: 0 20px; margin-left: 8px; border-radius: 4px; font-size: 20px; }

        /* Quick Actions */
        .quick-bar { padding: 10px; background: #0a0a0a; overflow-x: auto; white-space: nowrap; border-bottom: 1px solid #222; }
        .q-btn { background: #222; border: 1px solid #444; color: #aaa; padding: 6px 12px; border-radius: 15px; margin-right: 8px; font-size: 12px; }
        .q-btn:active { background: var(--text); color: #000; }
    </style>
</head>
<body>

<header>
    <div>
        <h1>BLE TERMINAL</h1>
        <div id="status">Getrennt</div>
    </div>
    <button id="btn-bt" onclick="connectBLE()">SCAN & CONNECT</button>
</header>

<div class="quick-bar">
    <button class="q-btn" onclick="send('help')">HELP</button>
    <button class="q-btn" onclick="send('vibro 1')">VIBRO</button>
    <button class="q-btn" onclick="send('date')">TIME</button>
    <button class="q-btn" onclick="send('power_info')">BATTERY</button>
    <button class="q-btn" onclick="send('uptime')">UPTIME</button>
    <button class="q-btn" onclick="term.innerHTML=''">CLS</button>
</div>

<div id="term"></div>

<div class="input-zone">
    <input type="text" id="cmd" placeholder="Befehl..." autocomplete="off">
    <button id="send" onclick="sendInput()">‚û§</button>
</div>

<script>
    // Flipper Zero Serial Service UUIDs
    const SERVICE_UUID = '8fe5b3d5-2e7f-4a98-2a48-7acc60fe0000';
    const TX_CHAR_UUID = '19ed82ae-ed21-4c9d-4145-228e61fe0000'; // Write
    const RX_CHAR_UUID = '19ed82ae-ed21-4c9d-4145-228e62fe0000'; // Notify (Read)

    let device, server, service, txChar, rxChar;
    const term = document.getElementById('term');
    const statusDiv = document.getElementById('status');

    async function connectBLE() {
        try {
            log("Suche Flipper...");
            
            device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'Flipper' }],
                optionalServices: [SERVICE_UUID]
            });

            device.addEventListener('gattserverdisconnected', onDisconnected);
            
            statusDiv.innerText = "Verbinde...";
            server = await device.gatt.connect();
            
            service = await server.getPrimaryService(SERVICE_UUID);
            
            // Get Characteristics
            txChar = await service.getCharacteristic(TX_CHAR_UUID);
            rxChar = await service.getCharacteristic(RX_CHAR_UUID);

            // Enable Notifications (Listening)
            await rxChar.startNotifications();
            rxChar.addEventListener('characteristicvaluechanged', handleNotifications);

            statusDiv.innerText = "Verbunden: " + device.name;
            statusDiv.style.color = "#00e5ff";
            document.getElementById('btn-bt').style.display = 'none';
            log(">>> BLUETOOTH VERBUNDEN <<<\n");

        } catch (error) {
            log("\n[ERROR] " + error);
            statusDiv.innerText = "Fehler";
        }
    }

    function handleNotifications(event) {
        const value = event.target.value;
        const decoder = new TextDecoder('utf-8');
        const text = decoder.decode(value);
        log(text, false);
    }

    async function send(command) {
        if (!txChar) return log("Nicht verbunden!");
        
        const encoder = new TextEncoder();
        // Flipper needs \r (Carriage Return) to execute
        const data = encoder.encode(command + '\r');
        
        try {
            await txChar.writeValue(data);
            // Echo local command is usually not needed as Flipper echoes back
        } catch (e) {
            log("[TX Error] " + e);
        }
    }

    function sendInput() {
        const input = document.getElementById('cmd');
        if(input.value) {
            send(input.value);
            input.value = '';
        }
    }

    function log(text, newLine = true) {
        term.innerText += text;
        term.scrollTop = term.scrollHeight;
    }

    function onDisconnected() {
        statusDiv.innerText = "Getrennt";
        statusDiv.style.color = "#666";
        document.getElementById('btn-bt').style.display = 'block';
        log("\n>>> VERBINDUNG VERLOREN <<<\n");
    }

    // Enter Key
    document.getElementById('cmd').addEventListener("keyup", e => {
        if (e.key === "Enter") sendInput();
    });
</script>

</body>
</html>
