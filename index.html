<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¬ Flipper Admin v2</title>
    <style>
        :root { --bg: #050505; --term: #00ff41; --ui: #222; --btn: #333; --accent: #ff8c00; }
        body { background: var(--bg); color: var(--term); font-family: 'Consolas', monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Top Bar */
        header { background: var(--ui); padding: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; }
        h1 { margin: 0; font-size: 1.1rem; color: #fff; letter-spacing: 1px; }
        #status { font-size: 0.8rem; color: #666; }
        #btn-conn { background: var(--accent); color: #000; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; }

        /* Dashboard Grid */
        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 10px; background: #111; border-bottom: 1px solid #333; }
        .d-btn { background: var(--btn); color: #ccc; border: 1px solid #444; padding: 8px 2px; border-radius: 4px; font-size: 0.7rem; text-align: center; cursor: pointer; }
        .d-btn:active { background: var(--accent); color: #000; }

        /* Terminal */
        #term { flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 12px; white-space: pre-wrap; line-height: 1.3; }
        
        /* Input */
        .cli-bar { display: flex; background: var(--ui); padding: 8px; border-top: 1px solid #444; }
        input { flex-grow: 1; background: #000; border: 1px solid #555; color: #fff; padding: 8px; border-radius: 4px; font-family: inherit; outline: none; }
        #btn-send { margin-left: 8px; background: #006400; color: #fff; border: none; padding: 0 15px; border-radius: 4px; font-size: 1.2rem; }
    </style>
</head>
<body>

<header>
    <div>
        <h1>FLIPPER ADMIN</h1>
        <div id="status">Getrennt</div>
    </div>
    <button id="btn-conn" onclick="connect()">SCAN</button>
</header>

<div class="dashboard">
    <div class="d-btn" onclick="send('device_info')">â„¹ï¸ INFO</div>
    <div class="d-btn" onclick="send('power_info')">ğŸ”‹ BATTERIE</div>
    <div class="d-btn" onclick="send('uptime')">â±ï¸ UPTIME</div>
    <div class="d-btn" onclick="send('date')">ğŸ“… ZEIT</div>
    
    <div class="d-btn" onclick="send('storage list /ext')">ğŸ“‚ SD ROOT</div>
    <div class="d-btn" onclick="send('storage list /ext/nfc')">ğŸ’³ NFC LIST</div>
    <div class="d-btn" onclick="send('vibro 1')">ğŸ“³ VIBRO</div>
    <div class="d-btn" onclick="send('led r 255')">ğŸ”´ LED ROT</div>
    
    <div class="d-btn" onclick="send('bt settings')">ğŸ“¶ BT INFO</div>
    <div class="d-btn" onclick="term.innerHTML=''">ğŸ§¹ CLS</div>
    <div class="d-btn" onclick="send('power_off')">ğŸ’€ OFF</div>
    <div class="d-btn" onclick="send('reboot')">ğŸ”„ REBOOT</div>
</div>

<div id="term">Waiting for connection...</div>

<div class="cli-bar">
    <input type="text" id="cmd" placeholder="Befehl..." autocomplete="off">
    <button id="btn-send" onclick="sendInput()">â</button>
</div>

<script>
    // Flipper Zero Serial UUIDs (Standard)
    const SERVICE_UUID = '8fe5b3d5-2e7f-4a98-2a48-7acc60fe0000';
    const TX_CHAR_UUID = '19ed82ae-ed21-4c9d-4145-228e61fe0000'; // Write to Flipper
    const RX_CHAR_UUID = '19ed82ae-ed21-4c9d-4145-228e62fe0000'; // Read from Flipper

    let device, rxChar, txChar;
    const term = document.getElementById('term');
    const statusDiv = document.getElementById('status');

    async function connect() {
        try {
            statusDiv.innerText = "Suche...";
            
            // FIX: "optionalServices" MUSS die Service-UUID enthalten, sonst blockt Android!
            device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'Flipper' }],
                optionalServices: [SERVICE_UUID] 
            });

            device.addEventListener('gattserverdisconnected', onDisconnected);

            statusDiv.innerText = "Verbinde GATT...";
            const server = await device.gatt.connect();
            
            statusDiv.innerText = "Hole Service...";
            const service = await server.getPrimaryService(SERVICE_UUID);
            
            statusDiv.innerText = "Hole Char...";
            rxChar = await service.getCharacteristic(RX_CHAR_UUID);
            txChar = await service.getCharacteristic(TX_CHAR_UUID);

            await rxChar.startNotifications();
            rxChar.addEventListener('characteristicvaluechanged', handleData);

            statusDiv.innerText = "Online: " + device.name;
            statusDiv.style.color = "#00ff41";
            document.getElementById('btn-conn').style.display = 'none';
            term.innerText = ">>> VERBUNDEN! <<<\n";
            
            // Wake up terminal
            send('\r'); 

        } catch (e) {
            term.innerText += `\n[ERROR] ${e}\n`;
            statusDiv.innerText = "Fehler";
            statusDiv.style.color = "red";
            
            // TIPP FÃœR DEN USER
            if(e.toString().includes("GATT")) {
                alert("GATT FEHLER? \n1. Schalte Bluetooth am Handy kurz aus/an.\n2. Entkoppele den Flipper in den Android-Einstellungen!\n3. Versuche es erneut.");
            }
        }
    }

    function handleData(event) {
        const val = event.target.value;
        const str = new TextDecoder().decode(val);
        term.innerText += str;
        term.scrollTop = term.scrollHeight;
    }

    async function send(cmd) {
        if (!txChar) return;
        try {
            const encoder = new TextEncoder();
            // Flipper braucht Carriage Return (\r)
            await txChar.writeValue(encoder.encode(cmd + '\r'));
        } catch (e) {
            term.innerText += `\n[TX ERROR] ${e}\n`;
        }
    }

    function sendInput() {
        const el = document.getElementById('cmd');
        if(el.value) { send(el.value); el.value = ''; }
    }

    function onDisconnected() {
        statusDiv.innerText = "Getrennt";
        statusDiv.style.color = "#666";
        document.getElementById('btn-conn').style.display = 'block';
        term.innerText += "\n>>> VERBINDUNG VERLOREN <<<\n";
    }
    
    // Enter Key Handler
    document.getElementById('cmd').addEventListener("keyup", e => {
        if (e.key === "Enter") sendInput();
    });
</script>

</body>
</html>
